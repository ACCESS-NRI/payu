#!/usr/bin/env python
# coding: utf-8

# TODO:
#   - Don't do model detection for `payu list`

import argparse
import os
import payu
import sys
import shutil as sh
import yaml

# TODO: Move to payu (somehow)
model_index = {'mom': payu.Mom,
               'mom4': payu.mom4,
               'mitgcm': payu.mitgcm,
               'gold': payu.gold}
default_config_fname = 'config.yaml'


#----
def payu_parse():

    #------------------
    # Parser generation

    parser = argparse.ArgumentParser()

    parser.add_argument('-m', '--model',
                        action='store',
                        dest='model_name',
                        default=None,
                        help='Select model type')

    parser.add_argument('-c', '--config',
                        action='store',
                        dest='config_path',
                        default=None,
                        help='Configuration path')

    subcmd = parser.add_subparsers()

    sweep_cmd = subcmd.add_parser('sweep')
    sweep_cmd.set_defaults(cmd=payu_sweep)

    sweep_cmd.add_argument('--hard',
                           action='store_true',
                           dest='hard_sweep')

    list_cmd = subcmd.add_parser('list')
    list_cmd.set_defaults(cmd=payu_list)

    # `args` is passed on to other functions after removing principal payu tags
    # so we convert it to a dict using `vars`
    args = vars(parser.parse_args())

    config_path = args.pop('config_path')
    model_name = args.pop('model_name')

    # Skip validation when listing supported models
    if args['cmd'] == payu_list:
        payu_list()
        sys.exit()

    #--------------------
    # Payu tag validation

    # Validate the configuration file path
    if config_path and not os.path.isfile(config_path):
        sys.exit('Error: Configuration file {f} does not exist.'.format(
                    f=config_path))

    # Assign the default config path if it exists
    if not config_path and os.path.isfile(default_config_fname):
        config_path = os.path.join(os.curdir, default_config_fname)

    # If no model name is specified, then check the config path
    if not model_name and config_path and os.path.isfile(config_path):
        with open(config_path, 'r') as config_file:
            config = yaml.load(config_file)
        try:
            model_name = config['model']
        except KeyError:
            pass

    # If there is still no defined model_name, try the parent directory
    if not model_name:
        model_name = os.path.basename(os.path.abspath(os.pardir))
        if not model_name in model_index.keys():
            sys.exit('payu: error: Unknown model.')
        else:
            print('payu: warning: Assuming model is {model} based on '
                  'parent directory name.'.format(model=model_name))

    #---------------------
    # Subcommand execution

    # Instantiate the model experiment
    model = model_index[model_name]
    expt = model()

    payu_cmd = args.pop('cmd')
    payu_cmd(expt, **args)


#--------------------------------------
def payu_sweep(expt, hard_sweep=False):
    expt.sweep(hard_sweep)


#--------------------------------------
def payu_list():
    print('Supported models: {0}'.format(' '.join(model_index.keys())))


#-------------------------
if __name__ == '__main__':

    # Default to display help if no subcommands or arguments are provided
    # NOTE: This can be removed after argparse supports default subparsers
    if len(sys.argv) == 1:
        sys.argv.append('-h')

    payu_parse()
